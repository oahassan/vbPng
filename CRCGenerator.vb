Option Explicit On

Imports System.IO

Public Class CRCGenerator
    Private Shared crcTbl As Dictionary(Of Byte, UInteger) = Nothing
    Private Shared crcTblLiteral() As UInteger = { _
    &H0UI, &H77073096UI, &HEE0E612CUI, &H990951BAUI, &H76DC419UI, _
    &H706AF48FUI, &HE963A535UI, &H9E6495A3UI, &HEDB8832UI, &H79DCB8A4UI, _
    &HE0D5E91EUI, &H97D2D988UI, &H9B64C2BUI, &H7EB17CBDUI, &HE7B82D07UI, _
    &H90BF1D91UI, &H1DB71064UI, &H6AB020F2UI, &HF3B97148UI, &H84BE41DEUI, _
    &H1ADAD47DUI, &H6DDDE4EBUI, &HF4D4B551UI, &H83D385C7UI, &H136C9856UI, _
    &H646BA8C0UI, &HFD62F97AUI, &H8A65C9ECUI, &H14015C4FUI, &H63066CD9UI, _
    &HFA0F3D63UI, &H8D080DF5UI, &H3B6E20C8UI, &H4C69105EUI, &HD56041E4UI, _
    &HA2677172UI, &H3C03E4D1UI, &H4B04D447UI, &HD20D85FDUI, &HA50AB56BUI, _
    &H35B5A8FAUI, &H42B2986CUI, &HDBBBC9D6UI, &HACBCF940UI, &H32D86CE3UI, _
    &H45DF5C75UI, &HDCD60DCFUI, &HABD13D59UI, &H26D930ACUI, &H51DE003AUI, _
    &HC8D75180UI, &HBFD06116UI, &H21B4F4B5UI, &H56B3C423UI, &HCFBA9599UI, _
    &HB8BDA50FUI, &H2802B89EUI, &H5F058808UI, &HC60CD9B2UI, &HB10BE924UI, _
    &H2F6F7C87UI, &H58684C11UI, &HC1611DABUI, &HB6662D3DUI, &H76DC4190UI, _
    &H1DB7106UI, &H98D220BCUI, &HEFD5102AUI, &H71B18589UI, &H6B6B51FUI, _
    &H9FBFE4A5UI, &HE8B8D433UI, &H7807C9A2UI, &HF00F934UI, &H9609A88EUI, _
    &HE10E9818UI, &H7F6A0DBBUI, &H86D3D2DUI, &H91646C97UI, &HE6635C01UI, _
    &H6B6B51F4UI, &H1C6C6162UI, &H856530D8UI, &HF262004EUI, &H6C0695EDUI, _
    &H1B01A57BUI, &H8208F4C1UI, &HF50FC457UI, &H65B0D9C6UI, &H12B7E950UI, _
    &H8BBEB8EAUI, &HFCB9887CUI, &H62DD1DDFUI, &H15DA2D49UI, &H8CD37CF3UI, _
    &HFBD44C65UI, &H4DB26158UI, &H3AB551CEUI, &HA3BC0074UI, &HD4BB30E2UI, _
    &H4ADFA541UI, &H3DD895D7UI, &HA4D1C46DUI, &HD3D6F4FBUI, &H4369E96AUI, _
    &H346ED9FCUI, &HAD678846UI, &HDA60B8D0UI, &H44042D73UI, &H33031DE5UI, _
    &HAA0A4C5FUI, &HDD0D7CC9UI, &H5005713CUI, &H270241AAUI, &HBE0B1010UI, _
    &HC90C2086UI, &H5768B525UI, &H206F85B3UI, &HB966D409UI, &HCE61E49FUI, _
    &H5EDEF90EUI, &H29D9C998UI, &HB0D09822UI, &HC7D7A8B4UI, &H59B33D17UI, _
    &H2EB40D81UI, &HB7BD5C3BUI, &HC0BA6CADUI, &HEDB88320UI, &H9ABFB3B6UI, _
    &H3B6E20CUI, &H74B1D29AUI, &HEAD54739UI, &H9DD277AFUI, &H4DB2615UI, _
    &H73DC1683UI, &HE3630B12UI, &H94643B84UI, &HD6D6A3EUI, &H7A6A5AA8UI, _
    &HE40ECF0BUI, &H9309FF9DUI, &HA00AE27UI, &H7D079EB1UI, &HF00F9344UI, _
    &H8708A3D2UI, &H1E01F268UI, &H6906C2FEUI, &HF762575DUI, &H806567CBUI, _
    &H196C3671UI, &H6E6B06E7UI, &HFED41B76UI, &H89D32BE0UI, &H10DA7A5AUI, _
    &H67DD4ACCUI, &HF9B9DF6FUI, &H8EBEEFF9UI, &H17B7BE43UI, &H60B08ED5UI, _
    &HD6D6A3E8UI, &HA1D1937EUI, &H38D8C2C4UI, &H4FDFF252UI, &HD1BB67F1UI, _
    &HA6BC5767UI, &H3FB506DDUI, &H48B2364BUI, &HD80D2BDAUI, &HAF0A1B4CUI, _
    &H36034AF6UI, &H41047A60UI, &HDF60EFC3UI, &HA867DF55UI, &H316E8EEFUI, _
    &H4669BE79UI, &HCB61B38CUI, &HBC66831AUI, &H256FD2A0UI, &H5268E236UI, _
    &HCC0C7795UI, &HBB0B4703UI, &H220216B9UI, &H5505262FUI, &HC5BA3BBEUI, _
    &HB2BD0B28UI, &H2BB45A92UI, &H5CB36A04UI, &HC2D7FFA7UI, &HB5D0CF31UI, _
    &H2CD99E8BUI, &H5BDEAE1DUI, &H9B64C2B0UI, &HEC63F226UI, &H756AA39CUI, _
    &H26D930AUI, &H9C0906A9UI, &HEB0E363FUI, &H72076785UI, &H5005713UI, _
    &H95BF4A82UI, &HE2B87A14UI, &H7BB12BAEUI, &HCB61B38UI, &H92D28E9BUI, _
    &HE5D5BE0DUI, &H7CDCEFB7UI, &HBDBDF21UI, &H86D3D2D4UI, &HF1D4E242UI, _
    &H68DDB3F8UI, &H1FDA836EUI, &H81BE16CDUI, &HF6B9265BUI, &H6FB077E1UI, _
    &H18B74777UI, &H88085AE6UI, &HFF0F6A70UI, &H66063BCAUI, &H11010B5CUI, _
    &H8F659EFFUI, &HF862AE69UI, &H616BFFD3UI, &H166CCF45UI, &HA00AE278UI, _
    &HD70DD2EEUI, &H4E048354UI, &H3903B3C2UI, &HA7672661UI, &HD06016F7UI, _
    &H4969474DUI, &H3E6E77DBUI, &HAED16A4AUI, &HD9D65ADCUI, &H40DF0B66UI, _
    &H37D83BF0UI, &HA9BCAE53UI, &HDEBB9EC5UI, &H47B2CF7FUI, &H30B5FFE9UI, _
    &HBDBDF21CUI, &HCABAC28AUI, &H53B39330UI, &H24B4A3A6UI, &HBAD03605UI, _
    &HCDD70693UI, &H54DE5729UI, &H23D967BFUI, &HB3667A2EUI, &HC4614AB8UI, _
    &H5D681B02UI, &H2A6F2B94UI, &HB40BBE37UI, &HC30C8EA1UI, &H5A05DF1BUI, _
    &H2D02EF8DUI}

    Private Shared Sub makeCRCTable()
        crcTbl = New Dictionary(Of Byte, UInteger)

        Dim c As UInteger
        Dim n, k As Short

        For n = 0 To 255
            c = CUInt(n)

            For k = 0 To 7
                If CBool(c And 1) Then
                    c = &HEDB88320UI Xor (c >> 1)
                Else
                    c = c >> 1
                End If
            Next

            crcTbl(CByte(n)) = c
        Next
    End Sub

    Private Shared Function update_crc( _
        ByVal crc As UInteger, _
        ByRef buffer As MemoryStream _
    ) As UInteger

        Dim c As UInteger = crc

        If crcTbl Is Nothing Then
            makeCRCTable()
        End If

        Dim byteBuffer(0) As Byte
        Dim numberRead As Integer = buffer.Read(byteBuffer, 0, 1)

        While numberRead > 0
            c = crcTbl((c Xor byteBuffer(0)) And &HFF) Xor (c >> 8)
            numberRead = buffer.Read(byteBuffer, 0, 1)
        End While

        Return c
    End Function

    Public Shared Function crc(ByRef buffer As MemoryStream) As UInteger

        Return update_crc(&HFFFFFFFFUI, buffer) Xor &HFFFFFFFFUI
    End Function
End Class
